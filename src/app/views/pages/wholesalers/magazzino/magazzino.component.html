<nav class="page-breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <h3>
                <div class="d-flex flex-row ">
                    <div><i class="mdi mdi-home-modern"></i></div>
                    <div class="ms-2 mt-2px">Warehouse</div>
                </div>

            </h3>
        </li>
    </ol>
</nav>

<div class="row">

    <div class="col-md-12 stretch-card">
        <div class="card">
            <div class="card-body">
                <p-table #dt [value]="magazzinos" responsiveLayout="stack" [rows]="5" [paginator]="true"
                    [columns]="selectedColumns" [exportHeader]="'customExportHeader'"
                    [globalFilterFields]="Filteredcolumns" [rowHover]="true" dataKey="id"
                    [rowsPerPageOptions]="[5,10,25,50]" [showCurrentPageReport]="true" styleClass="p-datatable-striped">

                    <ng-template pTemplate="caption">
                        <div class="row">
                            <div class="col-lg-12 col-md-12 col-12 text-lg-end text-start p-2">
                                <div class="p-ai-center p-jc-between">
                                    <span class="p-input-icon-right">
                                        <i class="pi pi-search"></i>
                                        <input pInputText type="text" id="globalFilter"
                                            (input)="dt.filterGlobal(searchedValue($event), 'contains')"
                                            placeholder="Search a product" />
                                    </span>
                                </div>
                            </div>
                        </div>
                    </ng-template>
                    <ng-template pTemplate="header" let-columns>
                        <tr>
                            <th style="width: 15%" *ngFor="let col of columns" [pSortableColumn]="col?.field">
                                {{col.header}} <p-sortIcon [field]="col?.field"></p-sortIcon>
                            </th>

                            <th style="width: 20%">Azioni</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-magazzino let-columns="columns" let-rowIndex="rowIndex">
                        <tr>
                            <td>
                                {{magazzino?.id}}
                            </td>
                            <td>
                                {{magazzino?.product + ((magazzino?.category || magazzino?.size) ? ' (' + (magazzino?.category ? magazzino?.category + ' ' : '') + (magazzino?.size ? magazzino?.size : '') + ')' : '') }}
                            </td>
                            <td>
                                {{magazzino?.id_sensore}}
                            </td>
                            <td>
                                {{magazzino?.batch_number}}
                            </td>
                            <td>
                                {{magazzino?.qty + ' ' + magazzino?.units + ((magazzino?.units == 'Bottles') ? ' (' + magazzino?.bottle_capacity + ' L)' : '')}}
                            </td>
                            <td>
                                {{magazzino?.name}}
                            </td>
                            <td>
                                {{magazzino?.type_of_packaging}}
                            </td>
                            <td>
                                {{magazzino?.producer}}
                            </td>
                            <td>
                                {{magazzino?.equivalent_temperature}}
                            </td>
                            <td>
                                {{magazzino?.in_warehouse_since_string}}
                            </td>
                            <td>
                                <!-- <button *ngIf="!magazzino?.father_id" class="btn btn-outline-primary me-2"
                                    (click)="onModalClick(divideModal);getTransactionHistoryByProduct(magazzino);initBatches();">Divide</button>
                                <button class="btn btn-success me-2"
                                    (click)="onModalClick(spedizioneModal);onSpedizione(magazzino)">Ship</button> -->
                                <button class="btn btn-outline-primary me-2"
                                    (click)="onModalClick(shelfLifeModal);getTransactionHistoryByProduct(magazzino)">Shelf-Life</button>
                                <button class="btn btn-outline-primary me-2"
                                    (click)="onModalClick(filieraModal);getTransactionHistoryByProduct(magazzino)">Details</button>
                            </td>
                        </tr>

                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="7" class="text-center"><b>No product found.</b></td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<ng-template #divideModal let-modal>
    <div class="modal-header">
        <button pButton pRipple icon="pi pi-times" class="close-button" id="closeModal" (click)="resetBatchesForm();modal.close('by: close icon')"></button>
        <div class="ms-4 mt-2 mb-2">
            <h4>
                <div class="d-flex flex-row bd-highlight">
                    <div class="bd-highlight ms-2">Divide batch</div>
                </div>
            </h4>
        </div>
    </div>
    <div class="modal-body ms-2">
        <div class="row">
            <div class="col-md-12">
                <div class="row mt-2">
                    <div class="col-md-12">
                        <form [formGroup]="batchesForm">
                            <div class="row">
                                <h6 class="mb-2">Batches</h6>
                                <ng-container *ngFor="let i of batches">
                                    <div class="row">
                                        <div class="col-sm-2">
                                            <div class="mb-3">
                                                <label class="form-label">Batch number<span class="text-danger">*</span></label>
                                                <input [formControlName]="'batch_number_' + i" class="form-control bg-transparent" type="text">
                                                <span *ngIf="batchesForm.get('batch_number_' + i).invalid && (batchesForm.get('batch_number_' + i).dirty || batchesForm.get('batch_number_' + i).touched) && batchesForm.get('batch_number_' + i).errors.required" class="validation-error">
                                                    Required field.
                                                </span>
                                            </div>
                                        </div>
                                        <div class="col-sm-2">
                                            <div class="mb-3">
                                                <label class="form-label">Sensor code</label>
                                                <input [formControlName]="'id_sensore_' + i" class="form-control bg-transparent" type="text">
                                            </div>
                                        </div>
                                        <div class="col-sm-2">
                                            <div class="mb-3">
                                                <label class="form-label">Category</label>
                                                <input [formControlName]="'category_' + i" class="form-control bg-transparent" type="text">
                                            </div>
                                        </div>
                                        <div class="col-sm-2">
                                            <div class="mb-3">
                                                <label class="form-label">Size</label>
                                                <input [formControlName]="'size_' + i" class="form-control bg-transparent" type="text">
                                            </div>
                                        </div>
                                        <div class="col-sm-2">
                                            <div class="mb-3">
                                                <label class="form-label">Quantity ({{ maggazzino?.units + ((maggazzino?.units == 'Bottles') ? ' [' + maggazzino?.bottle_capacity + ' L]' : '')}})<span class="text-danger">*</span></label>
                                                <input [formControlName]="'qty_' + i" class="form-control bg-transparent" type="text">
                                                <span *ngIf="batchesForm.get('qty_' + i).invalid && (batchesForm.get('qty_' + i).dirty || batchesForm.get('qty_' + i).touched) && batchesForm.get('qty_' + i).errors.required" class="validation-error">
                                                    Required field.
                                                </span>
                                                <span *ngIf="batchesForm.get('qty_' + i).invalid && (batchesForm.get('qty_' + i).dirty || batchesForm.get('qty_' + i).touched) && batchesForm.get('qty_' + i).errors.pattern" class="validation-error">
                                                    Insert a valid number.
                                                </span>
                                            </div>
                                        </div>
                                        <div *ngIf="(i > 0) && (i == (maxBatchId - 1))" class="col-sm-2 mt-acquisisci">
                                            <div *ngIf="(i > 1)" class="mb-1">
                                                <button pButton pRipple icon="pi pi-trash"
                                                    class="p-button-rounded p-button-danger"
                                                    (click)="removeBatch(i)"></button>
                                            </div>
                                            <div class="mb-1">
                                                <button pButton pRipple icon="pi pi-plus-circle"
                                                    class="p-button-rounded"
                                                    (click)="addBatch()"></button>
                                            </div>
                                        </div>
                                    </div>
                                </ng-container>
                            </div>
                            <div class="d-flex justify-content-center mt-3">
                                <span *ngIf="batchesErrors['quantities']" class="validation-error">
                                    Total quantity does not match with batch quantity: {{ maggazzino?.qty + ' ' + maggazzino?.units + ((maggazzino?.units == 'Bottles') ? ' [' + maggazzino?.bottle_capacity + ' L]' : '') }}
                                </span>
                            </div>
                            <div class="d-flex justify-content-center mt-3">
                                <button type="submit" (click)="divideBatches()" [disabled]="batchesForm.invalid || (batchesErrorsCounter > 0)" class="btn btn-primary fs-4">Divide</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</ng-template>

<ng-template #spedizioneModal let-modal>
    <div class="modal-header">
        <div class="ms-4 mt-2 mb-2">
            <h4>
                <div class="d-flex flex-row bd-highlight">
                    <div class="bd-highlight"><i class="mdi mdi-home-modern"></i></div>
                    <div class="bd-highlight ms-2">Start a new shipment</div>
                </div>
            </h4>
        </div>
    </div>

    <div class="modal-body ms-2">

        <div class="row">
            <div class="col-md-12">
                <form [formGroup]="wholeSalerDeliveryForm">
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="mb-3">
                                <label class="form-label">Carrier<span class="text-danger">*</span></label>
                                <select class="form-select" formControlName="trasportatore"
                                    [ngClass]="{ 'custom-error': submitted && f.trasportatore.errors }">
                                    <option value="" selected disabled>Select a carrier</option>
                                    <option *ngFor="let transporter of transporters"
                                        [value]="transporter.network_user.id">
                                        {{transporter?.network_user?.nome}}
                                    </option>
                                </select>
                                <span *ngIf="(!submitted && isValid('trasportatore')) || (submitted && f.trasportatore.errors?.required)" class="validation-error">
                                    Required field.
                                </span>
                            </div>
                        </div>
                        <div class="col-sm-12">
                            <div class="mb-3">
                                <label class="form-label">Name/Business name of the recipient<span
                                        class="text-danger">*</span></label>
                                <input class="form-control bg-transparent" type="text" formControlName="nome"
                                    placeholder="Name or Business name of the recipient"
                                    [ngClass]="{ 'custom-error': submitted && f.nome.errors }">
                                <span *ngIf="(!submitted && isValid('nome')) || (submitted && f.nome.errors?.required)" class="validation-error">
                                    Required field.
                                </span>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="mb-3">
                                <label class="form-label">Address<span class="text-danger">*</span></label>
                                <input type="text" class="form-control" placeholder="Address"
                                    formControlName="indirizzo"
                                    [ngClass]="{ 'custom-error': submitted && f.indirizzo.errors }">
                                <span *ngIf="(!submitted && isValid('indirizzo')) || (submitted && f.indirizzo.errors?.required)" class="validation-error">
                                    Required field.
                                </span>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="mb-3">
                                <label class="form-label">Postal Code<span class="text-danger">*</span></label>
                                <input class="form-control bg-transparent" type="text" placeholder="Postal Code"
                                    formControlName="cap" [ngClass]="{ 'custom-error': submitted && f.cap.errors }">
                                <span *ngIf="(!submitted && isValid('cap')) || (submitted && f.cap.errors?.required)" class="validation-error">
                                    Required field.
                                </span>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="mb-3">
                                <label class="form-label">City<span class="text-danger">*</span></label>
                                <input class="form-control bg-transparent" type="text" placeholder="City"
                                    formControlName="comune"
                                    [ngClass]="{ 'custom-error': submitted && f.comune.errors }">
                                <span *ngIf="(!submitted && isValid('comune')) || (submitted && f.comune.errors?.required)" class="validation-error">
                                    Required field.
                                </span>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="mb-3">
                                <label class="form-label">Country<span class="text-danger">*</span></label>
                                <input class="form-control bg-transparent" type="text" placeholder="Country"
                                    formControlName="country"
                                    [ngClass]="{ 'custom-error': submitted && f.country.errors }">
                                <span *ngIf="(!submitted && isValid('country')) || (submitted && f.country.errors?.required)" class="validation-error">
                                    Required field.
                                </span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary fs-4" id="closeModal" (click)="modal.close('by: close icon')">Cancel</button>
        <button type="button" class="btn btn-primary fs-4" (click)="onSubmit()">Save</button>
    </div>
</ng-template>

<ng-template #filieraModal let-modal>
    <div class="modal-header">
        <div class="ms-4 mt-2 mb-2">
            <h4>
                <div class="d-flex flex-row bd-highlight">
                    <div class="bd-highlight"><i class="mdi mdi-home-modern"></i></div>
                    <div class="bd-highlight ms-2">Details of the product supply chain</div>
                </div>
            </h4>
        </div>
    </div>

    <div class="modal-body ms-2">

        <div class="row">
            <div class="col-md-12">
                <ul ngbNav #horizontalCenterNav="ngbNav" class="nav-tabs justify-content-center">
                    <li [ngbNavItem]="1">
                        <a ngbNavLink>Supply chain</a>
                        <ng-template ngbNavContent>
                            <div class="left__container">
                                <div class="side__titles w-100">
                                    <!-- Product -->
                                    <div class="d-flex bd-highlight">
                                        <div class="bd-highlight w-12">
                                            <div class="progress__bar__container">
                                                <ul class="position-relative sm-media">
                                                    <li class="active" id="icon1"><img src="assets/images/person.svg"
                                                            class="img-fluid hydrated" alt="" /></li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="bd-highlight w-60">
                                            <div class="title__name">
                                                <h3>{{productDetails?.prodotto?.user?.nome}}</h3>
                                                <div class="d-flex bd-highlight ">
                                                    <div class="p-1 bd-highlight">
                                                        <img src="assets/images/location.svg" class="img-fluid ps-1"
                                                            alt="" />
                                                    </div>
                                                    <div class="p-1 bd-highlight">
                                                        <p class="para-d">
                                                            {{productDetails?.prodotto?.user?.indirizzo}},
                                                            {{productDetails?.prodotto?.user?.cap}}
                                                        </p>
                                                    </div>
                                                </div>
                                                <div class="d-flex bd-highlight">
                                                    <div class="p-1 bd-highlight">
                                                        <img src="assets/images/calendar.svg" class="img-fluid"
                                                            alt="" />
                                                    </div>
                                                    <div class="p-1 bd-highlight">
                                                        <p class="para-d">
                                                            {{productDetails?.prodotto.data_di_raccolto}}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- End Product -->

                                    <!-- Transactions -->
                                    <div class="d-flex bd-highlight"
                                        *ngFor="let transazion of productDetails?.transazioniHistory">
                                        <div class="bd-highlight w-12">
                                            <div class="progress__bar__container">
                                                <ul class="position-relative sm-media">
                                                    <li class="active" id="icon1"><img src="assets/images/distrib.svg"
                                                            class="img-fluid hydrated" alt="" /></li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="bd-highlight w-60">
                                            <div class="title__name">
                                                <h3>{{transazion?.trasportatore?.nome}}</h3>
                                                <div class="d-flex bd-highlight ">
                                                    <div class="p-1 bd-highlight">
                                                        <img src="assets/images/location.svg" class="img-fluid ps-1"
                                                            alt="" />
                                                    </div>
                                                    <div class="p-1 bd-highlight">
                                                        <p class="para-d">
                                                            {{transazion?.trasportatore?.indirizzo}},
                                                            {{transazion?.trasportatore?.cap}}
                                                        </p>

                                                    </div>
                                                </div>
                                                <div class="d-flex bd-highlight">
                                                    <div class="p-1 bd-highlight"><img src="assets/images/calendar.svg"
                                                            class="img-fluid" alt="" />
                                                    </div>
                                                    <div class="p-1 bd-highlight">
                                                        <p class="para-d">
                                                            {{transazion?.data_di_carico}} -
                                                            {{transazion?.data_di_scarico}}
                                                        </p>
                                                    </div>
                                                </div>

                                            </div>
                                        </div>

                                    </div>
                                    <!-- End Transactions -->

                                    <!-- WareHouse -->
                                    <!-- <div class="d-flex bd-highlight">
                                                                        <div class="bd-highlight w-12">
                                                                            <div class="progress__bar__container">
                                                                                <ul class="position-relative sm-media">
                                                                                    <li class="active" id="icon1"><img src="assets/images/cart.svg"
                                                                                            class="img-fluid hydrated" alt="" /></li>
                                                                                </ul>
                                                                            </div>
                                                                        </div>
                                                                        <div class="bd-highlight w-60">
                                                                            <div class="title__name">
                                                                                <h3>abc</h3>
                                                                                <div class="d-flex bd-highlight">
                                                                                    <div class="p-1 bd-highlight">
                                                                                        <img src="assets/images/location.svg" class="img-fluid ps-1"
                                                                                            alt="" />
                                                                                    </div>
                                                                                    <div class="p-1 bd-highlight">
                                                                                        <p class="para-d">
                                                                                            jkjhk</p>
                            
                                                                                    </div>
                                                                                </div>
                                                                                <div class="d-flex bd-highlight">
                                                                                    <div class="p-1 bd-highlight"><img
                                                                                            src="assets/images/calendar.svg" class="img-fluid"
                                                                                            alt="" />
                                                                                    </div>
                                                                                    <div class="p-1 bd-highlight">
                                                                                        <p class="para-d">6 Settembre 2022 - 14:55</p>
                                                                                    </div>
                                                                                </div>
                            
                                                                            </div>
                                                                        </div>
                            
                                                                    </div> -->
                                    <!-- End WareHouse -->
                                </div>
                            </div>
                        </ng-template>
                    </li>
                    <li [ngbNavItem]="2" (click)="getChartData('Temperature')">
                        <a ngbNavLink>Temperature</a>
                        <ng-template ngbNavContent>
                            <div class="d-flex flex-row bd-highlight mt-3">
                                <div class="p-2 bd-highlight mt-2" style="width: 80%;">
                                    <div class="card rounded">
                                        <div class="card-header bg-white">
                                            <h4>Temperature: {{temperatures[temperatures.length -1]}}째C</h4>
                                        </div>
                                        <div id="chart2">
                                            <apx-chart [series]="tempraturechartOptions.series"
                                                [chart]="tempraturechartOptions.chart"
                                                [xaxis]="tempraturechartOptions.xaxis"
                                                [stroke]="tempraturechartOptions.stroke"
                                                [dataLabels]="tempraturechartOptions.dataLabels"
                                                [tooltip]="tempraturechartOptions.tooltip">
                                            </apx-chart>
                                        </div>
                                    </div>


                                </div>

                                <div class="p-2 bd-highlight" style="width: 20%;">
                                    <div class="d-flex flex-column bd-highlight">
                                        <div class="p-2 bd-highlight">
                                            <div class="card border-color rounded">
                                                <div class="d-flex flex-column bd-highlight">
                                                    <div class="text-center mt-2">
                                                        <b>{{temperatures[temperatures.length-1]}} 째C</b>
                                                    </div>
                                                    <div class="text-center mt-1">Lowest:
                                                        {{getValue(temperatures,'min')}} 째C
                                                    </div>
                                                    <div class="text-center mt-1 mb-2">Highest:
                                                        {{getValue(temperatures,'max')}} 째C
                                                    </div>
                                                </div>
                                                <div class="card-footer text-center border-color bg-lightgreen">
                                                    <b>Temperature in range</b>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </ng-template>
                    </li>
                    <li [ngbNavItem]="3" (click)="getChartData('Humidity')">
                        <a ngbNavLink>Humidity</a>
                        <ng-template ngbNavContent>
                            <div class="d-flex flex-row bd-highlight mt-3">
                                <div class="p-2 bd-highlight mt-2" style="width: 80%;">
                                    <div class="card rounded">
                                        <div class="card-header bg-white">
                                            <h4>Humidity: {{humidities[humidities.length-1]}} %Rh</h4>
                                        </div>
                                        <div id="chart2">
                                            <apx-chart [series]="humiditychartOptions.series"
                                                [chart]="humiditychartOptions.chart"
                                                [xaxis]="humiditychartOptions.xaxis"
                                                [stroke]="humiditychartOptions.stroke"
                                                [dataLabels]="humiditychartOptions.dataLabels"
                                                [tooltip]="humiditychartOptions.tooltip">
                                            </apx-chart>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-2 bd-highlight" style="width: 20%;">
                                    <div class="d-flex flex-column bd-highlight">
                                        <div class="p-2 bd-highlight">
                                        </div>
                                        <div class="p-2 bd-highlight">
                                            <div class="card border-color rounded">
                                                <div class="d-flex flex-column bd-highlight">
                                                    <div class="text-center mt-2">
                                                        <b>{{humidities[humidities.length-1]}} %Rh</b>
                                                    </div>
                                                    <div class="text-center mt-1">Lowest:
                                                        {{getValue(humidities,'min')}} %Rh
                                                    </div>
                                                    <div class="text-center mt-1 mb-2">Highest:
                                                        {{getValue(humidities,'max')}} %Rh
                                                    </div>
                                                </div>
                                                <div class="card-footer text-center border-color bg-lightgreen">
                                                    <b>Humidity in range</b>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </ng-template>
                    </li>
                    <li [ngbNavItem]="4" (click)="getChartData('cov1')"> 
                        <a ngbNavLink>Cov1</a>
                        <ng-template ngbNavContent>
                            <div class="d-flex flex-row bd-highlight mt-3">
                                <div class="p-2 bd-highlight mt-2" style="width: 80%;">
                                    <div class="card rounded">
                                        <div class="card-header bg-white">
                                            <h4>Cov1: {{cov1s[cov1s.length -1]}} mg/m<sup>3</sup></h4>
                                        </div>
                                        <div id="chart2">
                                            <apx-chart [series]="cov1chartOptions.series"
                                                [chart]="cov1chartOptions.chart"
                                                [xaxis]="cov1chartOptions.xaxis"
                                                [stroke]="cov1chartOptions.stroke"
                                                [dataLabels]="cov1chartOptions.dataLabels"
                                                [tooltip]="cov1chartOptions.tooltip">
                                            </apx-chart>
                                        </div>
                                    </div>


                                </div>

                                <div class="p-2 bd-highlight" style="width: 20%;">
                                    <div class="d-flex flex-column bd-highlight">
                                        <div class="p-2 bd-highlight">
                                            <div class="card border-color rounded">
                                                <div class="d-flex flex-column bd-highlight">
                                                    <div class="text-center mt-2">
                                                        <b>{{cov1s[cov1s.length-1]}} mg/m<sup>3</sup></b>
                                                    </div>
                                                    <div class="text-center mt-1">Lowest:
                                                        {{getValue(cov1s,'min')}} mg/m<sup>3</sup>
                                                    </div>
                                                    <div class="text-center mt-1 mb-2">Highest:
                                                        {{getValue(cov1s,'max')}} mg/m<sup>3</sup>
                                                    </div>
                                                </div>
                                                <div class="card-footer text-center border-color bg-lightgreen">
                                                    <b>Cov1 in range</b>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </ng-template>
                    </li>
                    <li [ngbNavItem]="5" (click)="getChartData('cov2')"> 
                        <a ngbNavLink>Cov2</a>
                        <ng-template ngbNavContent>
                            <div class="d-flex flex-row bd-highlight mt-3">
                                <div class="p-2 bd-highlight mt-2" style="width: 80%;">
                                    <div class="card rounded">
                                        <div class="card-header bg-white">
                                            <h4>Cov2: {{cov2s[cov2s.length -1]}} mg/m<sup>3</sup></h4>
                                        </div>
                                        <div id="chart2">
                                            <apx-chart [series]="cov2chartOptions.series"
                                                [chart]="cov2chartOptions.chart"
                                                [xaxis]="cov2chartOptions.xaxis"
                                                [stroke]="cov2chartOptions.stroke"
                                                [dataLabels]="cov2chartOptions.dataLabels"
                                                [tooltip]="cov2chartOptions.tooltip">
                                            </apx-chart>
                                        </div>
                                    </div>


                                </div>

                                <div class="p-2 bd-highlight" style="width: 20%;">
                                    <div class="d-flex flex-column bd-highlight">
                                        <div class="p-2 bd-highlight">
                                            <div class="card border-color rounded">
                                                <div class="d-flex flex-column bd-highlight">
                                                    <div class="text-center mt-2">
                                                        <b>{{cov2s[cov2s.length-1]}} mg/m<sup>3</sup></b>
                                                    </div>
                                                    <div class="text-center mt-1">Lowest:
                                                        {{getValue(cov2s,'min')}} mg/m<sup>3</sup>
                                                    </div>
                                                    <div class="text-center mt-1 mb-2">Highest:
                                                        {{getValue(cov2s,'max')}} mg/m<sup>3</sup>
                                                    </div>
                                                </div>
                                                <div class="card-footer text-center border-color bg-lightgreen">
                                                    <b>Cov2 in range</b>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </ng-template>
                    </li>
                    <li [ngbNavItem]="6" (click)="getChartData('cov3')"> 
                        <a ngbNavLink>Cov3</a>
                        <ng-template ngbNavContent>
                            <div class="d-flex flex-row bd-highlight mt-3">
                                <div class="p-2 bd-highlight mt-2" style="width: 80%;">
                                    <div class="card rounded">
                                        <div class="card-header bg-white">
                                            <h4>Cov3: {{cov3s[cov3s.length -1]}} mg/m<sup>3</sup></h4>
                                        </div>
                                        <div id="chart2">
                                            <apx-chart [series]="cov3chartOptions.series"
                                                [chart]="cov3chartOptions.chart"
                                                [xaxis]="cov3chartOptions.xaxis"
                                                [stroke]="cov3chartOptions.stroke"
                                                [dataLabels]="cov3chartOptions.dataLabels"
                                                [tooltip]="cov3chartOptions.tooltip">
                                            </apx-chart>
                                        </div>
                                    </div>


                                </div>

                                <div class="p-2 bd-highlight" style="width: 20%;">
                                    <div class="d-flex flex-column bd-highlight">
                                        <div class="p-2 bd-highlight">
                                            <div class="card border-color rounded">
                                                <div class="d-flex flex-column bd-highlight">
                                                    <div class="text-center mt-2">
                                                        <b>{{cov3s[cov3s.length-1]}} mg/m<sup>3</sup></b>
                                                    </div>
                                                    <div class="text-center mt-1">Lowest:
                                                        {{getValue(cov3s,'min')}} mg/m<sup>3</sup>
                                                    </div>
                                                    <div class="text-center mt-1 mb-2">Highest:
                                                        {{getValue(cov3s,'max')}} mg/m<sup>3</sup>
                                                    </div>
                                                </div>
                                                <div class="card-footer text-center border-color bg-lightgreen">
                                                    <b>Cov3 in range</b>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </ng-template>
                    </li>
                    <li [ngbNavItem]="7" (click)="getChartData('cov4')"> 
                        <a ngbNavLink>Cov4</a>
                        <ng-template ngbNavContent>
                            <div class="d-flex flex-row bd-highlight mt-3">
                                <div class="p-2 bd-highlight mt-2" style="width: 80%;">
                                    <div class="card rounded">
                                        <div class="card-header bg-white">
                                            <h4>Cov4: {{cov4s[cov4s.length -1]}} mg/m<sup>3</sup></h4>
                                        </div>
                                        <div id="chart2">
                                            <apx-chart [series]="cov4chartOptions.series"
                                                [chart]="cov4chartOptions.chart"
                                                [xaxis]="cov4chartOptions.xaxis"
                                                [stroke]="cov4chartOptions.stroke"
                                                [dataLabels]="cov4chartOptions.dataLabels"
                                                [tooltip]="cov4chartOptions.tooltip">
                                            </apx-chart>
                                        </div>
                                    </div>


                                </div>

                                <div class="p-2 bd-highlight" style="width: 20%;">
                                    <div class="d-flex flex-column bd-highlight">
                                        <div class="p-2 bd-highlight">
                                            <div class="card border-color rounded">
                                                <div class="d-flex flex-column bd-highlight">
                                                    <div class="text-center mt-2">
                                                        <b>{{cov4s[cov4s.length-1]}} mg/m<sup>3</sup></b>
                                                    </div>
                                                    <div class="text-center mt-1">Lowest:
                                                        {{getValue(cov4s,'min')}} mg/m<sup>3</sup>
                                                    </div>
                                                    <div class="text-center mt-1 mb-2">Highest:
                                                        {{getValue(cov4s,'max')}} mg/m<sup>3</sup>
                                                    </div>
                                                </div>
                                                <div class="card-footer text-center border-color bg-lightgreen">
                                                    <b>Cov4 in range</b>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </ng-template>
                    </li>
                    <li [ngbNavItem]="8" (click)="getChartData('cov5')"> 
                        <a ngbNavLink>Cov5</a>
                        <ng-template ngbNavContent>
                            <div class="d-flex flex-row bd-highlight mt-3">
                                <div class="p-2 bd-highlight mt-2" style="width: 80%;">
                                    <div class="card rounded">
                                        <div class="card-header bg-white">
                                            <h4>Cov5: {{cov5s[cov5s.length -1]}} mg/m<sup>3</sup></h4>
                                        </div>
                                        <div id="chart2">
                                            <apx-chart [series]="cov5chartOptions.series"
                                                [chart]="cov5chartOptions.chart"
                                                [xaxis]="cov5chartOptions.xaxis"
                                                [stroke]="cov5chartOptions.stroke"
                                                [dataLabels]="cov5chartOptions.dataLabels"
                                                [tooltip]="cov5chartOptions.tooltip">
                                            </apx-chart>
                                        </div>
                                    </div>


                                </div>

                                <div class="p-2 bd-highlight" style="width: 20%;">
                                    <div class="d-flex flex-column bd-highlight">
                                        <div class="p-2 bd-highlight">
                                            <div class="card border-color rounded">
                                                <div class="d-flex flex-column bd-highlight">
                                                    <div class="text-center mt-2">
                                                        <b>{{cov5s[cov5s.length-1]}} mg/m<sup>3</sup></b>
                                                    </div>
                                                    <div class="text-center mt-1">Lowest:
                                                        {{getValue(cov5s,'min')}} mg/m<sup>3</sup>
                                                    </div>
                                                    <div class="text-center mt-1 mb-2">Highest:
                                                        {{getValue(cov5s,'max')}} mg/m<sup>3</sup>
                                                    </div>
                                                </div>
                                                <div class="card-footer text-center border-color bg-lightgreen">
                                                    <b>Cov5 in range</b>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </ng-template>
                    </li>
                    <li [ngbNavItem]="9" (click)="getChartData('light')"> 
                        <a ngbNavLink>Light</a>
                        <ng-template ngbNavContent>
                            <div class="d-flex flex-row bd-highlight mt-3">
                                <div class="p-2 bd-highlight mt-2" style="width: 80%;">
                                    <div class="card rounded">
                                        <div class="card-header bg-white">
                                            <h4>Light: {{lights[lights.length -1]}} lx</h4>
                                        </div>
                                        <div id="chart2">
                                            <apx-chart [series]="lightchartOptions.series"
                                                [chart]="lightchartOptions.chart"
                                                [xaxis]="lightchartOptions.xaxis"
                                                [stroke]="lightchartOptions.stroke"
                                                [dataLabels]="lightchartOptions.dataLabels"
                                                [tooltip]="lightchartOptions.tooltip">
                                            </apx-chart>
                                        </div>
                                    </div>


                                </div>

                                <div class="p-2 bd-highlight" style="width: 20%;">
                                    <div class="d-flex flex-column bd-highlight">
                                        <div class="p-2 bd-highlight">
                                            <div class="card border-color rounded">
                                                <div class="d-flex flex-column bd-highlight">
                                                    <div class="text-center mt-2">
                                                        <b>{{lights[lights.length-1]}} lx</b>
                                                    </div>
                                                    <div class="text-center mt-1">Lowest:
                                                        {{getValue(lights,'min')}} lx
                                                    </div>
                                                    <div class="text-center mt-1 mb-2">Highest:
                                                        {{getValue(lights,'max')}} lx
                                                    </div>
                                                </div>
                                                <div class="card-footer text-center border-color bg-lightgreen">
                                                    <b>Light in range</b>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </ng-template>
                    </li>
                    <li [ngbNavItem]="10" (click)="getChartData('vibration')"> 
                        <a ngbNavLink>Vibration</a>
                        <ng-template ngbNavContent>
                            <div class="d-flex flex-row bd-highlight mt-3">
                                <div class="p-2 bd-highlight mt-2" style="width: 80%;">
                                    <div class="card rounded">
                                        <div class="card-header bg-white">
                                            <h4>Vibration: {{vibrations[vibrations.length -1]}} m/s<sup>2</sup></h4>
                                        </div>
                                        <div id="chart2">
                                            <apx-chart [series]="vibrationchartOptions.series"
                                                [chart]="vibrationchartOptions.chart"
                                                [xaxis]="vibrationchartOptions.xaxis"
                                                [stroke]="vibrationchartOptions.stroke"
                                                [dataLabels]="vibrationchartOptions.dataLabels"
                                                [tooltip]="vibrationchartOptions.tooltip">
                                            </apx-chart>
                                        </div>
                                    </div>


                                </div>

                                <div class="p-2 bd-highlight" style="width: 20%;">
                                    <div class="d-flex flex-column bd-highlight">
                                        <div class="p-2 bd-highlight">
                                            <div class="card border-color rounded">
                                                <div class="d-flex flex-column bd-highlight">
                                                    <div class="text-center mt-2">
                                                        <b>{{vibrations[vibrations.length-1]}} m/s<sup>2</sup></b>
                                                    </div>
                                                    <div class="text-center mt-1">Lowest:
                                                        {{getValue(vibrations,'min')}} m/s<sup>2</sup>
                                                    </div>
                                                    <div class="text-center mt-1 mb-2">Highest:
                                                        {{getValue(vibrations,'max')}} m/s<sup>2</sup>
                                                    </div>
                                                </div>
                                                <div class="card-footer text-center border-color bg-lightgreen">
                                                    <b>Vibration in range</b>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </ng-template>
                    </li>
                </ul>

                <div [ngbNavOutlet]="horizontalCenterNav" class="border border-top-0 p-3"></div>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary fs-4" id="closeModal" (click)="modal.close('by: close icon')">Cancel</button>
    </div>
</ng-template>

<ng-template #shelfLifeModal let-modal>
    <div class="modal-body ms-2">
        <button pButton pRipple icon="pi pi-times" class="close-button" (click)="resetTemperature(0, false);modal.close('by: close icon')"></button>
        <div class="row">
            <div class="col-md-12">
                <h5 class="mb-3">Residual shelf-life</h5>
                <form [formGroup]="temperaturesForm">
                    <!-- <div *ngIf="residualShelfLifeType == 0" class="row sl-buttons">
                        <button type="button" class="btn btn-primary col-sm-3 sl-button" (click)="resetTemperature(1, true);">Use warehouse temperature</button>
                        <button type="button" class="btn btn-primary col-sm-3 sl-button" (click)="resetTemperature(2, false);">Provide single temperature</button>
                        <button type="button" class="btn btn-primary col-sm-3 sl-button" (click)="resetTemperature(3, false);">Provide times and temperatures</button>
                    </div> -->
                    <div *ngIf="residualShelfLifeType == 0" class="row sl-buttons">
                        <button type="button" class="btn btn-primary col-sm-3 sl-button" (click)="useAI();">AI ShelfLife</button>
                        <button type="button" class="btn btn-primary col-sm-3 sl-button" (click)="showSetExpiredDate();">Set as Expired</button>                        
                    </div>
                    <div *ngIf="residualShelfLifeType == 1" class="row mt-2">
                        <div class="col-md-12">
                            <div class="row">
                                <h6 class="mb-2">Warehouse temperature: {{ temperaturesForm.get('temp_0') ? temperaturesForm.get('temp_0').value + ' 째C' : 'Not found' }}</h6>
                            </div>
                        </div>
                    </div>
                    <div *ngIf="residualShelfLifeType == 2" class="row mt-2">
                        <div class="col-md-12">
                            <div class="row">
                                <h6 class="mb-2">Provide temperature</h6>
                                <ng-container *ngFor="let i of temps">
                                    <div class="col-sm-4">
                                        <div class="mb-3">
                                            <label class="form-label">Expected temperature (째C)<span
                                                class="text-danger">*</span></label>
                                            <input [formControlName]="'temp_' + i" class="form-control bg-transparent" type="text"
                                                placeholder="12.5">
                                            <span *ngIf="temperaturesForm.get('temp_' + i).invalid && (temperaturesForm.get('temp_' + i).dirty || temperaturesForm.get('temp_' + i).touched) && temperaturesForm.get('temp_' + i).errors.pattern" class="validation-error">
                                                Please provide a numeric value
                                            </span>
                                        </div>
                                    </div>
                                </ng-container>
                            </div>
                        </div>
                    </div>
                    <div *ngIf="residualShelfLifeType == 3" class="row mt-2">
                        <div class="col-md-12">
                            <div class="row">
                                <h6 class="mb-2">Temperatures range</h6>
                                <ng-container *ngFor="let i of temps">
                                    <div class="col-sm-4">
                                        <div class="mb-3">
                                            <label class="form-label">Time (h)<span
                                                class="text-danger">*</span></label>
                                            <input [formControlName]="'delta_' + i" class="form-control bg-transparent" type="text"
                                                placeholder="6">
                                            <span *ngIf="temperaturesForm.get('delta_' + i).invalid && (temperaturesForm.get('delta_' + i).dirty || temperaturesForm.get('delta_' + i).touched) && temperaturesForm.get('delta_' + i).errors.pattern" class="validation-error">
                                                Please provide a numeric value
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4">
                                        <div class="mb-3">
                                            <label class="form-label">Expected temperature (째C)<span
                                                class="text-danger">*</span></label>
                                            <input [formControlName]="'temp_' + i" class="form-control bg-transparent" type="text"
                                                placeholder="12.5">
                                            <span *ngIf="temperaturesForm.get('temp_' + i).invalid && (temperaturesForm.get('temp_' + i).dirty || temperaturesForm.get('temp_' + i).touched) && temperaturesForm.get('temp_' + i).errors.pattern" class="validation-error">
                                                Please provide a numeric value
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col-sm-4 mt-acquisisci">
                                        <div class="mb-3">
                                            <button pButton pRipple icon="pi pi-trash"
                                                class="p-button-rounded p-button-danger"
                                                (click)="removeTemperature(i)"></button>
                                        </div>
                                    </div>
                                </ng-container>
                                <div class="col-sm-4">
                                    <div class="mb-3">
                                        <button type="button" class="btn btn-primary w-100"
                                            (click)="addTemperature()">
                                                Add temperature
                                                <i class="mdi mdi-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </form>
                <div *ngIf="residualShelfLifeType == 4" class="row mt-2">
                        <div class="col-md-12">
                            <div class="row">
                                <label class="form-label">Date<span class="text-danger">*</span></label>

                                <p-calendar placeholder="Expiring date"
                                    [showTime]="true" [hourFormat]="'24'" [readonlyInput]="true" [showButtonBar]="false"
                                    dateFormat="yy-mm-dd" [showTransitionOptions]="'100ms'" [showIcon]="true"
                                    [hideTransitionOptions]="'100ms'" [inline]="false" [showOnFocus]="false"
                                    [maxDate]="maxDateValue" [appendTo]="'body'"  [baseZIndex]="9999"
                                    (onSelect)="onSelectDate()" [(ngModel)]="expired_date">
                                </p-calendar>
                                <button type="button" class="btn btn-primary mt-3 w-25" (click)="setExpiredDate()">Save</button>
                            </div>
                        </div>
                    </div>
                    <div *ngIf="showAIResult" class="row mt-2">
                        <div class="col-md-12">
                            <div class="row">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <!-- <th>Shelflife calcolata con algoritmo</th> -->
                                            <th>Shelflife calcolata con modello AI</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <!-- <td>{{calculated_SL | number:'1.2-2' }} <span *ngIf="calculated_SL !== null && calculated_SL !== undefined">Giorni</span></td> -->
                                            <td>{{AI_SL | number:'1.2-2' }} <span *ngIf="AI_SL !== null && AI_SL !== undefined">Giorni</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                                
                                <button type="button" class="btn btn-primary mt-3 w-25" (click)="calculateWithAI()">Start</button>
                            </div>
                        </div>
                    </div>
            </div>
        </div>
    </div>
    <div *ngIf="residualShelfLifeType != 0 && residualShelfLifeType != 4 && !showAIResult" class="modal-footer">
        <button type="button" class="btn btn-primary btn-lg w-100" id="closeModal" [disabled]="temperaturesForm.invalid || missingParam"
            (click)="onModalClick(resultModal);getResidualShelfLife(productDetails?.prodotto?.id);modal.close('by: close icon')">Calculate residual Shelf-Life
        </button>
    </div>
</ng-template>

<ng-template #resultModal let-modal>
    <div class="modal-header">
        <div class="ms-4 mt-2 mb-2">
            <h4>
                <div class="d-flex flex-row bd-highlight">
                    <div *ngIf="!missingTemp" class="bd-highlight ms-2">Residual shelf-life with provided temperatures</div>
                    <div *ngIf="missingTemp" class="bd-highlight ms-2">Please insert at least a temperature to calculate residual Shelf-Life</div>
                </div>
            </h4>
        </div>
    </div>
    <div *ngIf="!missingTemp" class="modal-body ms-2">
        <div class="row">
            <div class="col-md-12 stretch-card">
                <div class="card">
                    <div class="card-body">
                        <p-table #rsld [value]="residualShelfLifeData" responsiveLayout="stack" styleClass="p-datatable-striped">
                            <ng-template pTemplate="header">
                                <tr>
                                    <th>
                                        Product
                                    </th>
                                    <th>
                                        Production/Crop date
                                    </th>
                                    <th>
                                        Equivalent temperature (째C)
                                    </th>
                                    <th>
                                        Shelf Life (days)
                                    </th>
                                    <th>
                                        Equivalent humidity (%)
                                    </th>
                                    <th>
                                        Coefficient
                                    </th>
                                    <th>
                                        Adjusted Shelf Life for humidity (days)
                                    </th>
                                    <th>
                                        Residual Shelf Life
                                    </th>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-shelflife let-columns="columns">
                                <tr>
                                    <td>
                                        <span class="p-column-title">Product</span>
                                        {{ shelflife?.product.nome_prodotto }}
                                    </td>
                                    <td>
                                        <span class="p-column-title">Production/Crop date</span>
                                        {{ shelflife?.data_di_raccolto + ' (' + shelflife?.from_crop_day + ' day' + ((shelflife?.from_crop_day != 1) ? 's' : '') + ' ago)' }}
                                    </td>
                                    <td>
                                        <span class="p-column-title">Equivalent temperature (째C)</span>
                                        {{ shelflife?.equivalent_temperature.toFixed(2) }}
                                    </td>
                                    <td>
                                        <span class="p-column-title">Shelf Life (days)</span>
                                        {{ shelflife?.average_shelflife.toFixed(2) }}
                                    </td>
                                    <td>
                                        <span class="p-column-title">Equivalent humidity (%)</span>
                                        {{ shelflife?.equivalent_humidity.toFixed(2) }}
                                    </td>
                                    <td>
                                        <span class="p-column-title">Coefficient</span>
                                        {{ shelflife?.humidity_coefficient }}
                                    </td>
                                    <td>
                                        <span class="p-column-title">Adjusted Shelf Life for humidity (days)</span>
                                        {{ shelflife?.adjusted_shelflife.toFixed(2) }}
                                    </td>
                                    <td [class.error-color]="(shelflife.residual_shelflife < 0)">
                                        <span class="p-column-title">Residual Shelf Life</span>
                                        <b>{{ shelflife.shelflife_date + ' (' + ((shelflife.residual_shelflife < 0) ? (shelflife.residual_shelflife * -1) + ' day' + ((shelflife.residual_shelflife != -1) ? 's' : '') + ' ago)' : shelflife.residual_shelflife + ' day' + ((shelflife.residual_shelflife != 1) ? 's' : '') + ')') }}</b>
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>
                </div>
            </div>
            <div *ngIf="residualShelfLifeError" class="col-md-12">
                <div class="row mt-2 validation-error">
                    <p><b>{{ residualShelfLifeError }}</b></p>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer text-center" id="chudi">
        <button type="button" class="btn btn-primary w-50" id="closeModal" (click)="modal.close('by: close icon')">
            Close</button>
    </div>
</ng-template>